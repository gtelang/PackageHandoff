<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-----------------------------------------------------------------------------
    reactive-banana
------------------------------------------------------------------------------}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards, NamedFieldPuns #-}</span><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Reactive</span><span class="hs-operator">.</span><span class="hs-identifier">Banana</span><span class="hs-operator">.</span><span class="hs-identifier">Prim</span><span class="hs-operator">.</span><span class="hs-identifier">Dependencies</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>    </span><span class="hs-comment">-- | Utilities for operating on node dependencies.</span><span>
</span><a name="line-7"></a><span>    </span><a href="Reactive.Banana.Prim.Dependencies.html#addChild"><span class="hs-identifier hs-var">addChild</span></a><span class="hs-special">,</span><span> </span><a href="Reactive.Banana.Prim.Dependencies.html#changeParent"><span class="hs-identifier hs-var">changeParent</span></a><span class="hs-special">,</span><span> </span><a href="Reactive.Banana.Prim.Dependencies.html#buildDependencies"><span class="hs-identifier hs-var">buildDependencies</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Mem</span><span class="hs-operator">.</span><span class="hs-identifier">Weak</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Reactive.Banana.Prim.Graph.html"><span class="hs-identifier">Reactive</span><span class="hs-operator">.</span><span class="hs-identifier">Banana</span><span class="hs-operator">.</span><span class="hs-identifier">Prim</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Graph</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><a href="Reactive.Banana.Prim.Types.html"><span class="hs-identifier">Reactive</span><span class="hs-operator">.</span><span class="hs-identifier">Banana</span><span class="hs-operator">.</span><span class="hs-identifier">Prim</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><a href="Reactive.Banana.Prim.Util.html"><span class="hs-identifier">Reactive</span><span class="hs-operator">.</span><span class="hs-identifier">Banana</span><span class="hs-operator">.</span><span class="hs-identifier">Prim</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-comment">{-----------------------------------------------------------------------------
    Accumulate dependency information for nodes
------------------------------------------------------------------------------}</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- | Add a new child node to a parent node.</span><span>
</span><a name="line-23"></a><span class="hs-identifier">addChild</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#DependencyBuilder"><span class="hs-identifier hs-type">DependencyBuilder</span></a><span>
</span><a name="line-24"></a><a name="addChild"><a href="Reactive.Banana.Prim.Dependencies.html#addChild"><span class="hs-identifier">addChild</span></a></a><span> </span><a name="local-1627442809"><a href="#local-1627442809"><span class="hs-identifier">parent</span></a></a><span> </span><a name="local-1627442810"><a href="#local-1627442810"><span class="hs-identifier">child</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Endo</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reactive.Banana.Prim.Graph.html#insertEdge"><span class="hs-identifier hs-var">Graph</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insertEdge</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627442809"><span class="hs-identifier hs-var">parent</span></a><span class="hs-special">,</span><a href="#local-1627442810"><span class="hs-identifier hs-var">child</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- | Assign a new parent to a child node.</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- INVARIANT: The child may have only one parent node.</span><span>
</span><a name="line-28"></a><span class="hs-identifier">changeParent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-type">Pulse</span></a><span> </span><a href="#local-1627442807"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-type">Pulse</span></a><span> </span><a href="#local-1627442808"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#DependencyBuilder"><span class="hs-identifier hs-type">DependencyBuilder</span></a><span>
</span><a name="line-29"></a><a name="changeParent"><a href="Reactive.Banana.Prim.Dependencies.html#changeParent"><span class="hs-identifier">changeParent</span></a></a><span> </span><a name="local-1627442811"><a href="#local-1627442811"><span class="hs-identifier">child</span></a></a><span> </span><a name="local-1627442812"><a href="#local-1627442812"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442811"><span class="hs-identifier hs-var">child</span></a><span class="hs-special">,</span><span> </span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442812"><span class="hs-identifier hs-var">parent</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-comment">-- | Execute the information in the dependency builder</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- to change network topology.</span><span>
</span><a name="line-33"></a><span class="hs-identifier">buildDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#DependencyBuilder"><span class="hs-identifier hs-type">DependencyBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><a name="buildDependencies"><a href="Reactive.Banana.Prim.Dependencies.html#buildDependencies"><span class="hs-identifier">buildDependencies</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Endo</span><span> </span><a name="local-1627442813"><a href="#local-1627442813"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627442814"><a href="#local-1627442814"><span class="hs-identifier">parents</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-35"></a><span>    </span><span class="hs-identifier hs-var">sequence_</span><span> </span><span class="hs-special">[</span><a href="#local-1627442816"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="Reactive.Banana.Prim.Dependencies.html#doAddChild"><span class="hs-identifier hs-var">doAddChild</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627442817"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1627442816"><a href="#local-1627442816"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reactive.Banana.Prim.Graph.html#listParents"><span class="hs-identifier hs-var">Graph</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">listParents</span></a><span> </span><a href="#local-1627442815"><span class="hs-identifier hs-var">gr</span></a><span class="hs-special">,</span><span> </span><a name="local-1627442817"><a href="#local-1627442817"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reactive.Banana.Prim.Graph.html#getChildren"><span class="hs-identifier hs-var">Graph</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getChildren</span></a><span> </span><a href="#local-1627442815"><span class="hs-identifier hs-var">gr</span></a><span> </span><a href="#local-1627442816"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-36"></a><span>    </span><span class="hs-identifier hs-var">sequence_</span><span> </span><span class="hs-special">[</span><a href="#local-1627442818"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="Reactive.Banana.Prim.Dependencies.html#doChangeParent"><span class="hs-identifier hs-var">doChangeParent</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627442819"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442818"><a href="#local-1627442818"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442819"><a href="#local-1627442819"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627442814"><span class="hs-identifier hs-var">parents</span></a><span class="hs-special">]</span><span>
</span><a name="line-37"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>    </span><a name="local-1627442815"><a href="#local-1627442815"><span class="hs-identifier">gr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627442813"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="Reactive.Banana.Prim.Graph.html#emptyGraph"><span class="hs-identifier hs-var">Graph</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">emptyGraph</span></a><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">{-----------------------------------------------------------------------------
    Set dependencies of individual notes
------------------------------------------------------------------------------}</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- | Add a child node to the children of a parent 'Pulse'.</span><span>
</span><a name="line-44"></a><span class="hs-identifier">connectChild</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-type">Pulse</span></a><span> </span><a href="#local-1627442806"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- ^ Parent node whose '_childP' field is to be updated.</span><span>
</span><a name="line-46"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-comment">-- ^ Child node to add.</span><span>
</span><a name="line-47"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Weak</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>                </span><span class="hs-comment">-- ^ Weak reference with the child as key and the parent as value.</span><span>
</span><a name="line-49"></a><a name="connectChild"><a href="Reactive.Banana.Prim.Dependencies.html#connectChild"><span class="hs-identifier">connectChild</span></a></a><span> </span><a name="local-1627442820"><a href="#local-1627442820"><span class="hs-identifier">parent</span></a></a><span> </span><a name="local-1627442821"><a href="#local-1627442821"><span class="hs-identifier">child</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-50"></a><span>    </span><a name="local-1627442822"><a href="#local-1627442822"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reactive.Banana.Prim.Types.html#mkWeakNodeValue"><span class="hs-identifier hs-var">mkWeakNodeValue</span></a><span> </span><a href="#local-1627442821"><span class="hs-identifier hs-var">child</span></a><span> </span><a href="#local-1627442821"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-51"></a><span>    </span><a href="Reactive.Banana.Prim.Util.html#modify%27"><span class="hs-identifier hs-var">modify'</span></a><span> </span><a href="#local-1627442820"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reactive.Banana.Prim.Types.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><a href="Reactive.Banana.Prim.Types.html#childrenP"><span class="hs-identifier hs-var">childrenP</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627442822"><span class="hs-identifier hs-var">w</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>    </span><a href="Reactive.Banana.Prim.Types.html#mkWeakNodeValue"><span class="hs-identifier hs-var">mkWeakNodeValue</span></a><span> </span><a href="#local-1627442821"><span class="hs-identifier hs-var">child</span></a><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442820"><span class="hs-identifier hs-var">parent</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- child keeps parent alive</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- | Add a child node to a parent node and update evaluation order.</span><span>
</span><a name="line-55"></a><span class="hs-identifier">doAddChild</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><a name="doAddChild"><a href="Reactive.Banana.Prim.Dependencies.html#doAddChild"><span class="hs-identifier">doAddChild</span></a></a><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442823"><a href="#local-1627442823"><span class="hs-identifier">parent</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442824"><a href="#local-1627442824"><span class="hs-identifier">child</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>    </span><a name="local-1627442825"><a href="#local-1627442825"><span class="hs-identifier">level1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_levelP</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442824"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-58"></a><span>    </span><a name="local-1627442826"><a href="#local-1627442826"><span class="hs-identifier">level2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_levelP</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442823"><span class="hs-identifier hs-var">parent</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627442827"><a href="#local-1627442827"><span class="hs-identifier">level</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627442825"><span class="hs-identifier hs-var">level1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-1627442826"><span class="hs-identifier hs-var">level2</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>    </span><a name="local-1627442828"><a href="#local-1627442828"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627442823"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">`</span><a href="Reactive.Banana.Prim.Dependencies.html#connectChild"><span class="hs-identifier hs-var">connectChild</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442824"><span class="hs-identifier hs-var">child</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>    </span><a href="Reactive.Banana.Prim.Util.html#modify%27"><span class="hs-identifier hs-var">modify'</span></a><span> </span><a href="#local-1627442824"><span class="hs-identifier hs-var">child</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reactive.Banana.Prim.Types.html#set"><span class="hs-identifier hs-var">set</span></a><span> </span><a href="Reactive.Banana.Prim.Types.html#levelP"><span class="hs-identifier hs-var">levelP</span></a><span> </span><a href="#local-1627442827"><span class="hs-identifier hs-var">level</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Reactive.Banana.Prim.Types.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><a href="Reactive.Banana.Prim.Types.html#parentsP"><span class="hs-identifier hs-var">parentsP</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627442828"><span class="hs-identifier hs-var">w</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-identifier">doAddChild</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442829"><a href="#local-1627442829"><span class="hs-identifier">parent</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627442830"><a href="#local-1627442830"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627442829"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">`</span><a href="Reactive.Banana.Prim.Dependencies.html#connectChild"><span class="hs-identifier hs-var">connectChild</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627442830"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- | Remove a node from its parents and all parents from this node.</span><span>
</span><a name="line-65"></a><span class="hs-identifier">removeParents</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-type">Pulse</span></a><span> </span><a href="#local-1627442805"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><a name="removeParents"><a href="Reactive.Banana.Prim.Dependencies.html#removeParents"><span class="hs-identifier">removeParents</span></a></a><span> </span><a name="local-1627442831"><a href="#local-1627442831"><span class="hs-identifier">child</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-67"></a><span>    </span><a name="local-1627442832"><a href="#local-1627442832"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">@</span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-var">Pulse</span></a><span class="hs-special">{</span><a name="local-1627442833"><a href="#local-1627442833"><span class="hs-identifier">_parentsP</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442831"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-68"></a><span>    </span><span class="hs-comment">-- delete this child (and dead children) from all parent nodes</span><span>
</span><a name="line-69"></a><span>    </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-1627442833"><span class="hs-identifier hs-var">_parentsP</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627442834"><a href="#local-1627442834"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-70"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442835"><a href="#local-1627442835"><span class="hs-identifier">parent</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">deRefWeak</span><span> </span><a href="#local-1627442834"><span class="hs-identifier hs-var">w</span></a><span>  </span><span class="hs-comment">-- get parent node</span><span>
</span><a name="line-71"></a><span>        </span><span class="hs-identifier hs-var">finalize</span><span> </span><a href="#local-1627442834"><span class="hs-identifier hs-var">w</span></a><span>                      </span><span class="hs-comment">-- severe connection in garbage collector</span><span>
</span><a name="line-72"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-1627442836"><a href="#local-1627442836"><span class="hs-identifier">isGoodChild</span></a></a><span> </span><a name="local-1627442837"><a href="#local-1627442837"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442831"><span class="hs-identifier hs-var">child</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">deRefWeak</span><span> </span><a href="#local-1627442837"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-73"></a><span>        </span><a name="local-1627442838"><a href="#local-1627442838"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><a href="#local-1627442836"><span class="hs-identifier hs-var">isGoodChild</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">_childrenP</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442835"><span class="hs-identifier hs-var">parent</span></a><span>
</span><a name="line-74"></a><span>        </span><a href="Reactive.Banana.Prim.Util.html#modify%27"><span class="hs-identifier hs-var">modify'</span></a><span> </span><a href="#local-1627442835"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reactive.Banana.Prim.Types.html#set"><span class="hs-identifier hs-var">set</span></a><span> </span><a href="Reactive.Banana.Prim.Types.html#childrenP"><span class="hs-identifier hs-var">childrenP</span></a><span> </span><a href="#local-1627442838"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-75"></a><span>    </span><span class="hs-comment">-- replace parents by empty list</span><span>
</span><a name="line-76"></a><span>    </span><a href="Reactive.Banana.Prim.Util.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><a href="#local-1627442831"><span class="hs-identifier hs-var">child</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627442832"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">{</span><span class="hs-identifier">_parentsP</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | Set the parent of a pulse to a different pulse.</span><span>
</span><a name="line-79"></a><span class="hs-identifier">doChangeParent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-type">Pulse</span></a><span> </span><a href="#local-1627442803"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reactive.Banana.Prim.Types.html#Pulse"><span class="hs-identifier hs-type">Pulse</span></a><span> </span><a href="#local-1627442804"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><a name="doChangeParent"><a href="Reactive.Banana.Prim.Dependencies.html#doChangeParent"><span class="hs-identifier">doChangeParent</span></a></a><span> </span><a name="local-1627442839"><a href="#local-1627442839"><span class="hs-identifier">child</span></a></a><span> </span><a name="local-1627442840"><a href="#local-1627442840"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-comment">-- remove all previous parents and connect to new parent</span><span>
</span><a name="line-82"></a><span>    </span><a href="Reactive.Banana.Prim.Dependencies.html#removeParents"><span class="hs-identifier hs-var">removeParents</span></a><span> </span><a href="#local-1627442839"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-83"></a><span>    </span><a name="local-1627442841"><a href="#local-1627442841"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627442840"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">`</span><a href="Reactive.Banana.Prim.Dependencies.html#connectChild"><span class="hs-identifier hs-var">connectChild</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442839"><span class="hs-identifier hs-var">child</span></a><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>    </span><a href="Reactive.Banana.Prim.Util.html#modify%27"><span class="hs-identifier hs-var">modify'</span></a><span> </span><a href="#local-1627442839"><span class="hs-identifier hs-var">child</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reactive.Banana.Prim.Types.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><a href="Reactive.Banana.Prim.Types.html#parentsP"><span class="hs-identifier hs-var">parentsP</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627442841"><span class="hs-identifier hs-var">w</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>    </span><span class="hs-comment">-- calculate level difference between parent and node</span><span>
</span><a name="line-87"></a><span>    </span><a name="local-1627442842"><a href="#local-1627442842"><span class="hs-identifier">levelParent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_levelP</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442840"><span class="hs-identifier hs-var">parent</span></a><span>
</span><a name="line-88"></a><span>    </span><a name="local-1627442843"><a href="#local-1627442843"><span class="hs-identifier">levelChild</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_levelP</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442839"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-89"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627442844"><a href="#local-1627442844"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627442842"><span class="hs-identifier hs-var">levelParent</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-1627442843"><span class="hs-identifier hs-var">levelChild</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-comment">-- level parent - d = level child - 1</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>    </span><span class="hs-comment">-- lower all parents of the node if the parent was higher than the node</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-1627442844"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-94"></a><span>        </span><a name="local-1627442845"><a href="#local-1627442845"><span class="hs-identifier">parents</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Reactive.Banana.Prim.Graph.html#dfs"><span class="hs-identifier hs-var">Graph</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">dfs</span></a><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a href="#local-1627442840"><span class="hs-identifier hs-var">parent</span></a><span class="hs-special">)</span><span> </span><a href="Reactive.Banana.Prim.Dependencies.html#getParents"><span class="hs-identifier hs-var">getParents</span></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-1627442845"><span class="hs-identifier hs-var">parents</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442846"><a href="#local-1627442846"><span class="hs-identifier">node</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-96"></a><span>            </span><a href="Reactive.Banana.Prim.Util.html#modify%27"><span class="hs-identifier hs-var">modify'</span></a><span> </span><a href="#local-1627442846"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reactive.Banana.Prim.Types.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><a href="Reactive.Banana.Prim.Types.html#levelP"><span class="hs-identifier hs-var">levelP</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">subtract</span><span> </span><a href="#local-1627442844"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">{-----------------------------------------------------------------------------
    Helper functions
------------------------------------------------------------------------------}</span><span>
</span><a name="line-101"></a><span class="hs-identifier">getChildren</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span class="hs-special">]</span><span>
</span><a name="line-102"></a><a name="getChildren"><a href="Reactive.Banana.Prim.Dependencies.html#getChildren"><span class="hs-identifier">getChildren</span></a></a><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442847"><a href="#local-1627442847"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reactive.Banana.Prim.Util.html#deRefWeaks"><span class="hs-identifier hs-var">deRefWeaks</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">_childrenP</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442847"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-identifier">getChildren</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-identifier">getParents</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="Reactive.Banana.Prim.Types.html#SomeNode"><span class="hs-identifier hs-type">SomeNode</span></a><span class="hs-special">]</span><span>
</span><a name="line-106"></a><a name="getParents"><a href="Reactive.Banana.Prim.Dependencies.html#getParents"><span class="hs-identifier">getParents</span></a></a><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Types.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><a name="local-1627442848"><a href="#local-1627442848"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Reactive.Banana.Prim.Util.html#deRefWeaks"><span class="hs-identifier hs-var">deRefWeaks</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">_parentsP</span><span> </span><span class="hs-special">(</span><a href="Reactive.Banana.Prim.Util.html#readRef"><span class="hs-identifier hs-var">readRef</span></a><span> </span><a href="#local-1627442848"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span class="hs-identifier">getParents</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-108"></a></pre></body></html>